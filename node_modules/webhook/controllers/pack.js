/*!
 * /controllers/pack.js 负责打包的中间件
 * Copyright(c) 2012
 * Author: jifeng <wade428@163.com>
 */

var urlLib = require('url');
var parse = urlLib.parse;
var project = require('../lib/project');

var Pack = function (options) {
  this.options = options;
  this.project = project(this.options);
};

Pack.prototype.middleware = function() {
  var self = this;
  return function (req, res, next) {
    var urlObj = parse(req.url, true);
    var appname = urlObj.query.appname;
    var user = urlObj.query.user;
    if (!appname || !user) {
      return res.end('appname or user is Invalid');
    }
    self.project.initRep(appname, user, function (err, info) {
      if (err) {
        return next(err)
      }
      res.statusCode = 200;
      res.write(info);
      res.end('pack ' + appname + ' ok');
    });
  };
};

module.exports = function (options) {
  return new Pack(options);
};