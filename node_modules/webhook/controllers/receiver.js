/*!
 * /controllers/receiver.js 负责接受文件的中间件
 * Copyright(c) 2012
 * Author: jifeng.zjd <jifeng.zjd@alibaba-inc.com>
 */

var urlLib = require('url');
var parse = urlLib.parse;
var fs = require('fs');
var path = require('path');
var util = require('../util');
var socket = require('../socket');
var ep = require('event-pipe');

var Receiver = function (options) {
  this.options = options;
};

Receiver.prototype.middleware = function() {
  var self = this;
  var rundir = this.options.rundir;
  var sock = path.join(rundir, 'console.sock');
  return function (req, res, next) {
    var urlObj = parse(req.url, true);
    var params = urlObj.query;
    
    var appname = params.appname;
    if (!appname) {
      return next(new Error('Invalid Appname'));
    }

    var chunks = [];
    var buffer = undefined;
    req.on('data', function (chunk) {
      chunks.push(chunk);
    });

    req.on('end', function(chunk) {
      buffer = Buffer.concat(chunks);
      var file = path.join(rundir, appname);
      file = file + '.tgz';
      var exist = fs.existsSync(file);
      //如果文件存在，就直接删除
      if (exist) {
        fs.unlinkSync(file);
      }
      ep(function () {
        fs.writeFile(file, buffer, { encoding: 'binary' }, this);
      }, function (err) {
        if (err) {
          return next(err);
        }
        //解包
        util.spawn('tar', [ 'xzvf', file], { cwd: rundir }, this);
      }, function (err, str) {
        if (err) {
          return next(err);
        }
        var dir = path.join(rundir, path.basename(file, '.tgz'));
        res.statusCode = 200;
        res.write(str);  
        socket.post(sock, 'mount+' + encodeURIComponent(dir), this);
      }, function (err, s) {
         if (err) {
           res.write(err.message);
         } else {
           res.write(s);
         }
        res.end('appname ' + appname + ' has received successfully!'); 
      }).run();
    });
  };
};

module.exports = function (options) {
  return new Receiver(options);
};
