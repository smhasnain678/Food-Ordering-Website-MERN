/*!
 * webhook lib/project.js
 * Copyright(c) 2013
 * Author: jifeng <wade428@163.com>
 */

var fs = require('fs-extra');
var ep = require('event-pipe');
var path = require('path');

var util = require('../util');



var Project = function (options) {
  this.options = options;
};


Project.prototype.initRep = function (appname, user, cb) {
  var config = this.options
  var gitURL = config.git;
  var url = gitURL.replace('{appname}', appname);
  var dir = config.rundir + appname;
  var results = [];
  ep(function () {
    fs.exists(dir, this);
  }, function (flag) {
    if (flag) {
      fs.removeSync(dir, this);
    }
    util.spawn('git', ['clone', url, dir ], this);
  }, function (err, item) {
    results.push(item);
    //建立本地stg分支
    util.spawn('git', ['checkout', 'stg'], {cwd: dir}, this);
  }, function (err, item) {
    results.push(item);
    //返回master分支
    util.spawn('git', ['checkout', 'master'], {cwd: dir}, this);
  }, function (err, item) {
    results.push(item);
    //判断stg分支的版本是否比master
    util.spawn('git', ['log',  'stg', '..master'], {cwd: dir}, this);
  }, function (err, info) {
    results.push(info);
    if (info) {
      return cb(new Error('branch stg is fall behind master\n' + info));
    }
    var buildFile = dir + '/build.sh';
    util.spawn('sh', [buildFile, user], { cwd: dir, changeUser: false }, this);
  }, function (err, item) {
    results.push(item);
    util.spawn('cp', ['-rf', 'release', appname], {cwd: path.join(dir, 'out')}, this);
  }, function (err, item) {
    results.push(item);
    util.spawn('tar', ['czvf', appname + '.tgz', appname], {cwd: path.join(dir, 'out')}, this)
  }, function (err, item) {
    results.push(item);
    cb(null, results.join('\n----------------------------------------------------------------------\n'))
  }).run();
};

module.exports = function (options) {
  return new Project(options);
};